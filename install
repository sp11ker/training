# install Script for lifecycle tab
# Clone the Terraform files
git clone https://github.com/sp11ker/training.git
cd training

# Add HashiCorp GPG key
curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg

# Add HashiCorp apt repo
echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" > /etc/apt/sources.list.d/hashicorp.list

# Update ONLY HashiCorp repo to speed it up
apt-get update -o Dir::Etc::sourcelist="sources.list.d/hashicorp.list" \
               -o Dir::Etc::sourceparts="-" \
               -o APT::Get::List-Cleanup="0"

# Install Terraform
apt-get install -y terraform

# Configure Terraform
terraform init -input=false
terraform plan -out=tfplan -input=false
terraform apply -input=false -auto-approve tfplan

# Configure SSH
cp my-keypair.pem /root/.ssh/


# Extra commands SSH
terraform output instance_public_ip
ssh -i /root/.ssh/my-keypair.pem ec2-user@x.x.x.x



# OLD CONFIG DO NOT USE
# Deploy EC2 with Terraform and setup SSH

# Clone the Terraform configs from Github repo
git clone https://github.com/sp11ker/training.git
cd training

# Download and install Terraform
curl -O https://releases.hashicorp.com/terraform/1.12.2/terraform_1.12.2_linux_amd64.zip
unzip terraform_1.12.2_linux_amd64.zip
mv terraform /usr/local/bin/

# Intialise Terraform and run the plan
terraform init -input=false
terraform plan -out=tfplan -input=false
terraform apply -input=false -auto-approve tfplan

# Copy the keys for the SSH login
cp my-keypair.pem /root/.ssh/
